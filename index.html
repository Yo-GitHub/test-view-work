<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WordJamå¼ï¼šã‚°ãƒ«åˆ† & ãƒãƒƒãƒãƒ³ã‚°</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#4b6bfb">
<style>
  :root{
    --bg:#f7f7fb; --ink:#222; --muted:#666; --card:#fff; --ok:#d8f6d8; --ng:#ffd9e0; --accent:#4b6bfb;
    --bin:#f0f3ff; --bin-b:#cfd8ff;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
  header{background:#fff;border-bottom:1px solid #eceff6;padding:16px}
  h1{font-size:18px;margin:0 0 6px}
  .sub{color:var(--muted);font-size:12px}
  main{max-width:1100px;margin:20px auto;padding:0 16px 32px}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab{border:1px solid #dde2f5;background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .panel{background:#fff;border:1px solid #e7e9f3;border-radius:16px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.04)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{background:#eef1ff;color:#2b3ac8;border:1px solid #dfe4ff;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
  .btn{appearance:none;border:none;background:var(--accent);color:#fff;font-weight:700;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.secondary{background:#e9ecf8;color:#2a2f3a}
  .btn.ghost{background:transparent;color:#2a2f3a;border:1px solid #d8ddea}
  .select{appearance:none;border:1px solid #d8ddea;background:#fff;padding:8px 10px;border-radius:10px;font-weight:700}
  @media (max-width:520px){ .select{max-width:100%} }
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:12px}
  .bank{min-height:72px;background:#fafbff;border:1px dashed #d7dbef;border-radius:12px;padding:10px}
  .cards{display:flex;flex-wrap:wrap;gap:8px}
 .card{background:var(--card);border:2px solid #e1e4f2;border-radius:12px;padding:10px 12px;cursor:grab;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;touch-action:none}
 #mcqOptions .card.selected { outline: 2px solid #7aa2ff; transform: translateY(-1px); }
#mcqMultiBar .btn { padding: .4rem .8rem; }
 .bank, .col, .cards, #leftList, #rightList, #binContainer{ -webkit-user-select:none; user-select:none; }
  .card:active{cursor:grabbing}
  .card.vanish{ animation: popout .22s ease-out forwards }
  .bin{background:var(--bin);border:2px solid var(--bin-b);border-radius:12px;padding:10px;}
  .bin.hint{outline:2px dashed #9bb0ff}
  .bin-title{font-weight:700;margin-bottom:6px}
  .result{margin-top:10px;padding:10px;border-radius:10px;border:1px solid #e6e9f7;background:#fbfcff}
  .ok{background:var(--ok)!important;border-color:#21a321!important}
  .ng{background:var(--ng)!important;border-color:#d21c49!important}
  .pairwrap{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .col{background:#fbfbff;border:1px solid #e5e8f6;border-radius:12px;padding:10px;min-height:220px;position:relative;overflow:auto}
  .col h3{margin:0 0 8px;font-size:14px}
  .col .bin{ margin-bottom:10px; }
  .item{background:#fff;border:2px solid #e1e4f2;border-radius:10px;padding:8px 10px;margin:6px 0;cursor:pointer}
  .item.sel{border-color:#7aa2ff;box-shadow:0 0 0 3px #e7edff}
  /* æ”¹è¡Œã‚„è¤‡æ•°ã‚¹ãƒšãƒ¼ã‚¹ã‚’ãã®ã¾ã¾è¡¨ç¤º */
.mcq .qtitle,
.card,
.item,
.bin-title { white-space: pre-wrap; line-break: anywhere; }
#groupQuestionTitle { max-width: 50vw; display:inline-block; }
#matchQuestionTitle { max-width: 50vw; display:inline-block; }
  /* ãƒãƒƒãƒãƒ³ã‚°ï¼šãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ¼”å‡º */
  .item.dragging{opacity:.5}
  .item.dropzone{outline:2px dashed #9bb0ff; background:#eef3ff}
  .item.ok{background:#d8f6d8!important; border-color:#21a321!important}
  .item.miss{background:#ffd9e0!important; border-color:#d21c49!important}
  @keyframes popout{ from{transform:scale(1);opacity:1} to{transform:scale(.9);opacity:0} }
  .vanish{ animation: popout .22s ease-out forwards }
  /* é¸æŠä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆç›¸æ‰‹å´ã«å¤§ããè¡¨ç¤ºï¼‰ */
  .pickOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none}
  .pickOverlay.show{display:flex}
  .pickBadge{pointer-events:auto;background:rgba(255,255,255,.96);border:2px solid #e1e4f2;border-radius:12px;padding:10px 14px;font-weight:700;box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .pickBadge .x{margin-left:10px;border:1px solid #d8ddea;background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;font-weight:700}
  .pairs{margin-top:10px;font-size:13px;color:#333}
  .foot{margin-top:8px;color:var(--muted);font-size:12px}
  /* ===== ãƒ¢ãƒã‚¤ãƒ«è£œåŠ©UIï¼šä¸‹éƒ¨ã‚·ãƒ¼ãƒˆï¼†é…ç½®ä¸€è¦§ ===== */
.assigner{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e8f6;box-shadow:0 -14px 30px rgba(0,0,0,.18);padding:12px;z-index:1000;display:none}
.assigner.show{display:block}
.assigner .ttl{font-weight:700;margin:0 0 8px;font-size:14px}
.assigner .opts{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.assigner .opt{appearance:none;border:2px solid #e1e4f2;background:#f7f8ff;padding:12px;border-radius:12px;font-weight:700;cursor:pointer}
.assigner .opt.bin{background:#eef1ff;border-color:#dfe4ff}
.assigner .cancel{margin-top:10px;appearance:none;border:1px solid #d8ddea;background:#fff;padding:10px;border-radius:10px;font-weight:700;width:100%;cursor:pointer}
/* ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
.summary{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1200}
.summary.show{display:flex}
.summary .sheet{background:#fff;border-radius:14px;border:1px solid #e6e9f7;max-width:620px;width:92%;padding:16px 18px;box-shadow:0 18px 42px rgba(0,0,0,.18)}
.summary h3{margin:0 0 8px;font-size:16px}
.summary .meta{color:#555;font-size:13px;margin-bottom:8px}
.summary table{width:100%;border-collapse:collapse;margin-top:6px}
.summary th,.summary td{border-bottom:1px solid #eef1fa;padding:6px 4px;font-size:13px;text-align:left}
.summary .rowbtn{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
.summary .btn{padding:10px 14px;border-radius:10px;font-weight:700}
.summary .ghost{background:#fff;border:1px solid #d8ddea;color:#2a2f3a}
/* ===== å››æŠï¼ˆMCQï¼‰ ===== */
.mcq .qtitle{font-weight:700;font-size:16px;line-height:1.6}
.mcq .qhint{color:var(--muted);font-size:12px;margin-top:4px}
.mcq .grid{display:grid;grid-template-columns:repeat(2,minmax(180px,1fr));gap:12px;margin-top:12px}
.mcq .card{background:#fff;border:2px solid #e7e9f3;border-radius:12px;padding:14px;cursor:pointer;transition:transform .08s ease,border-color .15s;user-select:none}
.mcq .card:hover{transform:translateY(-2px);border-color:#cfd6ff}
.mcq .card.correct{background:var(--ok);border-color:#18a118}
.mcq .card.wrong{background:var(--ng);border-color:#d11a44}
@media (max-width:520px){ .mcq .grid{grid-template-columns:1fr} }
/* ãƒ¢ãƒã‚¤ãƒ«æ™‚ã®ãƒ’ãƒƒãƒˆã‚¨ãƒªã‚¢æ‹¡å¤§ï¼†1ã‚«ãƒ©ãƒ å¿—å‘ */
@media (max-width:780px){
  .grid-2{grid-template-columns:1fr}
  .card{padding:14px 14px}
}
  /* ãƒ’ãƒƒãƒˆã‚¨ãƒªã‚¢æ‹¡å¤§ï¼ˆãƒ¢ãƒã‚¤ãƒ«ï¼‰ */
  @media (max-width:780px){
    .card{padding:14px 14px}
  }
</style>
</head>
<body>
<header>
  <h1>WordJamå¼ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ï¼šã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ & ãƒãƒƒãƒãƒ³ã‚°</h1>
  <div class="sub">ã€Œè¦šãˆã‚‹ã€ã‹ã‚‰ã€Œæ•´ç†ã—ã¦æ€ã„å‡ºã™ã€ã¸ã€‚èª¤ç­”ã¯æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã§å¤šã‚ã«å‡ºã—ã¾ã™ã€‚</div>
</header>

<main>
  <div class="tabs">
    <button class="tab active" id="tabGroup">ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</button>
    <button class="tab" id="tabMatch">ãƒãƒƒãƒãƒ³ã‚°</button>
    <button class="tab" id="tabMCQ">å››æŠ</button>
  </div>

  <!-- ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ -->
  <section class="panel" id="groupPanel">
    <div class="row">
      <label class="pill" for="groupThemeSelect">ãŠé¡Œï¼š</label>
      <select id="groupThemeSelect" class="select">
        <option value="__auto__">ï¼ˆè‡ªå‹•ï¼šthemes.json ã‚’æ¤œå‡ºï¼‰</option>
      </select>
      <button class="btn" id="resetG">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn secondary" id="shuffleG">ã‚«ãƒ¼ãƒ‰ã‚’å…¥ã‚Œæ›¿ãˆ</button>
      <button class="btn ghost" id="showSummaryG">ç›´å‰ã®è¦ç´„</button>
      <span class="pill" id="poolInfo">ãƒ—ãƒ¼ãƒ«: 8 / è¡¨ç¤º: 8</span>
    </div>

    <div class="pairwrap" style="margin-top:12px">
      <div class="col">
        <h3>å·¦ï¼šã‚«ãƒ¼ãƒ‰</h3>
        <div class="bank" id="bank">
          <div class="cards" id="cardBank"></div>
        </div>
      </div>
      <div class="col">
        <h3>å³ï¼šåˆ†é¡å…ˆ</h3>
        <div id="binContainer"></div>
      </div>
    </div>

    <div class="result" id="groupResult">çµæœï¼šæœªæ¡ç‚¹ã§ã”ã–ã‚‹ã€‚</div>
  </section>

  <!-- ãƒãƒƒãƒãƒ³ã‚° -->
  <section class="panel" id="matchPanel" style="display:none">
    <div class="row">
      <label class="pill" for="matchThemeSelect">ãŠé¡Œï¼š</label>
      <select id="matchThemeSelect" class="select">
        <option value="__auto__">ï¼ˆè‡ªå‹•ï¼šthemes.json ã‚’æ¤œå‡ºï¼‰</option>
      </select>
      <button class="btn" id="resetM">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="btn secondary" id="shuffleM">ä¸¦ã³æ›¿ãˆ</button>
      <button class="btn ghost" id="showSummaryM">ç›´å‰ã®è¦ç´„</button>
      <span class="pill" id="matchPoolInfo">ãƒ—ãƒ¼ãƒ«: 6 / è¡¨ç¤º: 4</span>
    </div>

    <div class="pairwrap" style="margin-top:12px">
      <div class="col">
        <h3 id="matchLeftHdr">å·¦ï¼šç”¨èª</h3>
        <div id="leftList"></div>
        <div class="pickOverlay" id="overlayLeft" aria-hidden="true"></div>
      </div>
      <div class="col">
        <h3 id="matchRightHdr">å³ï¼šèª¬æ˜</h3>
        <div id="rightList"></div>
        <div class="pickOverlay" id="overlayRight" aria-hidden="true"></div>
      </div>
    </div>

    <div class="pairs" id="pairView">é¸æŠï¼šãªã—</div>
    <div class="result" id="matchResult">çµæœï¼šæœªæ¡ç‚¹ã§ã”ã–ã‚‹ã€‚</div>
    <div class="foot">å·¦ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å³ã«é‡ã­ã‚‹ã€‚æ­£è§£ã¯æ¶ˆãˆã€ãƒŸã‚¹ã¯ä¸€ç¬èµ¤ãç‚¹æ»…ã™ã‚‹ã§ã”ã–ã‚‹ã€‚</div>
  </section>
  <!-- å››æŠï¼ˆMCQï¼‰ -->
<section class="panel" id="mcqPanel" style="display:none">
  <div class="row">
    <label class="pill" for="mcqThemeSelect">ãŠé¡Œï¼š</label>
    <select id="mcqThemeSelect" class="select">
      <option value="__auto__">ï¼ˆè‡ªå‹•ï¼šthemes.json ã‚’æ¤œå‡ºï¼‰</option>
    </select>
    <button class="btn" id="resetMCQ">ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn ghost" id="showSummaryMCQ">ç›´å‰ã®è¦ç´„</button>
    <span class="pill" id="mcqMeterPill">é€²è¡Œ 0/0</span>
  </div>

  <div class="mcq" style="margin-top:12px">
    <div class="qbox">
      <div class="qtitle" id="mcqQuestion">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="qhint" id="mcqHint"></div>
    </div>
    <div class="grid" id="mcqOptions"></div>
    <div id="mcqMultiBar" style="display:none;gap:.5rem;align-items:center;">
      <span id="mcqMultiHint">è¤‡æ•°é¸æŠï¼š0ä»¶</span>
      <button id="mcqCommit" class="btn">ç¢ºå®š</button>
    </div>
    <div class="explain" id="mcqExplain" style="display:none">
      <div class="hd">è§£èª¬</div>
      <div id="mcqReason"></div>
      <div class="qhint" id="mcqSource"></div>
      <div class="nav" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="mcqNextBtn">æ¬¡ã®å•é¡Œã¸</button>
        <button class="btn secondary" id="mcqRetryBtn">ã‚‚ã†ä¸€åº¦ã“ã®å•é¡Œ</button>
      </div>
    </div>
  </div>
</section>
  <!-- ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ï¼šã‚¿ãƒƒãƒ—ã§ã‚«ãƒ¼ãƒ‰é…å±ã™ã‚‹ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆ -->
  <div class="assigner" id="assigner" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="ttl" id="assignerTitle">é…å±å…ˆã‚’é¸æŠ</div>
    <div class="opts" id="assignerOpts"></div>
    <button class="cancel" id="assignerCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
<div class="summary" id="summary" aria-hidden="true">
  <div class="sheet">
    <h3 id="sumTitle">ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„</h3>
    <div class="meta" id="sumMeta"></div>
    <table>
      <tbody id="sumBody"></tbody>
    </table>
    <div class="rowbtn">
      <button class="btn ghost" id="btnExport">ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’JSONä¿å­˜</button>
      <button class="btn ghost" id="btnRetry">åŒã˜ã‚»ãƒƒãƒˆã§å†æŒ‘æˆ¦</button>
      <button class="btn" id="btnNext">æ¬¡ã®ã‚»ãƒƒãƒˆã¸</button>
    </div>
  </div>
</div>
</main>
<script>
  (function () {
    let dragging = false;
    // æ—¢å­˜ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ï¼çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã§ dragging ã‚’ç«‹ã¦ã‚‹
    window.addEventListener('dragstart', () => dragging = true, true);
    window.addEventListener('dragend', () => dragging = false, true);
    // ã‚¿ãƒƒãƒç«¯æœ«ã§ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹
    window.addEventListener('touchmove', (e) => {
      if (dragging) { e.preventDefault(); }
    }, { passive: false });
  })();
</script>
<script>
/* ====== ãƒ‡ãƒ¼ã‚¿ ====== */
// å…ˆé ­ã® <script> ä»˜è¿‘ã«è¿½åŠ 
function normalizeText(s){
  return (typeof s === 'string') ? s.replace(/\\n/g, '\n') : s;
}
// ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ï¼šã‚«ãƒ¼ãƒ‰ï¼ˆå„ã‚«ãƒ¼ãƒ‰ã«æ­£ã—ã„ group ã‚’ä»˜ä¸ï¼‰
const GROUP_DATA = [
  {label:"éãƒãƒ³ã‚¬ãƒ³é…¸ã‚«ãƒªã‚¦ãƒ ", group:"ç¬¬1é¡"},
  {label:"å¡©ç´ é…¸ãƒŠãƒˆãƒªã‚¦ãƒ ", group:"ç¬¬1é¡"},
  {label:"ç¡«é»„", group:"ç¬¬2é¡"},
  {label:"èµ¤ãƒªãƒ³", group:"ç¬¬2é¡"},
  {label:"ãƒŠãƒˆãƒªã‚¦ãƒ ï¼ˆé‡‘å±ï¼‰", group:"ç¬¬3é¡"},
  {label:"é»„ãƒªãƒ³", group:"ç¬¬3é¡"},
  {label:"ã‚¬ã‚½ãƒªãƒ³", group:"ç¬¬4é¡"},
  {label:"ç¯æ²¹", group:"ç¬¬4é¡"}
];

// --- group multi-question support ---
let groupQuestions = [];      // ç¾åœ¨ãƒ­ãƒ¼ãƒ‰ä¸­ãƒ•ã‚¡ã‚¤ãƒ«ã® questions[]ï¼ˆãªã‘ã‚Œã°å˜ä¸€ã‚’åŒ…ã‚€ï¼‰
let groupQFile = null;        // ç¾åœ¨ã® JSON ãƒ‘ã‚¹
let groupHasMulti = false; // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒJSONãŒ questions[] ã‚’æŒã¤ã‹

  function ensureGroupQuestionTitle() {
    let span = document.getElementById('groupQuestionTitle');
    if (!span) {
      span = document.createElement('span');
      span.id = 'groupQuestionTitle';
      span.className = 'pill';
      span.style.marginLeft = '8px';
      // å·®ã—è¾¼ã¿å…ˆï¼šãŠé¡Œã‚»ãƒ¬ã‚¯ãƒˆã®ç›´å¾Œ
      const themeSel = document.getElementById('groupThemeSelect');
      if (themeSel && themeSel.parentElement) {
        themeSel.parentElement.insertBefore(span, themeSel.nextSibling);
      } else {
        const row = document.getElementById('groupControls')
          || document.getElementById('groupHeader')
          || document.querySelector('#groupTab .rowbtn')
          || document.getElementById('groupPanel').querySelector('.row');
        row && row.appendChild(span);
      }
    }
    return span;
  }
// ãƒãƒƒãƒãƒ³ã‚°ï¼šé¡â†”å®šç¾©
const MATCH_LEFT = [
  {label:"ç¬¬1é¡", bin:"ç¬¬1é¡"},
  {label:"ç¬¬2é¡", bin:"ç¬¬2é¡"},
  {label:"ç¬¬3é¡", bin:"ç¬¬3é¡"},
  {label:"ç¬¬4é¡", bin:"ç¬¬4é¡"},
  {label:"ç¬¬5é¡", bin:"ç¬¬5é¡"},
  {label:"ç¬¬6é¡", bin:"ç¬¬6é¡"}
];
const MATCH_RIGHT = [
  {label:"é…¸åŒ–æ€§å›ºä½“", bin:"ç¬¬1é¡"},
  {label:"å¯ç‡ƒæ€§å›ºä½“ï¼ˆæ‘©æ“¦ãƒ»è¡æ’ƒã§å±é™ºï¼‰", bin:"ç¬¬2é¡"},
  {label:"è‡ªç„¶ç™ºç«æ€§ã¾ãŸã¯ç¦æ°´æ€§ç‰©è³ª", bin:"ç¬¬3é¡"},
  {label:"å¼•ç«æ€§æ¶²ä½“ï¼ˆè’¸æ°—ãŒå¯ç‡ƒï¼‰", bin:"ç¬¬4é¡"},
  {label:"è‡ªå·±åå¿œæ€§ç‰©è³ªï¼ˆåŠ ç†±ãƒ»è¡æ’ƒã§ç™ºç«/çˆ†ç™ºï¼‰", bin:"ç¬¬5é¡"},
  {label:"é…¸åŒ–æ€§æ¶²ä½“ï¼ˆå¼·ã„é…¸åŒ–åŠ›ãƒ»è…é£Ÿæ€§ï¼‰", bin:"ç¬¬6é¡"}
];

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const rand = arr => arr.sort(()=>Math.random()-0.5);

/* ===== å­¦ç¿’çµ±è¨ˆãƒ»ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° ===== */
const STORAGE_KEY = 'wj_stats_v1';
let stats = loadStats();
let sessionLog = []; // ä»Šãƒ©ã‚¦ãƒ³ãƒ‰ã®è©¦è¡Œè¨˜éŒ²

function loadStats(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }
  catch(_){ return {}; }
}
function saveStats(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(stats)); }
function statOf(id){
  if(!stats[id]) stats[id] = {ok:0, ng:0};
  return stats[id];
}
function weightById(id){
  const s = statOf(id);
  // é‡ã¿ = 1 + 2*missï¼ˆå¿…è¦ãªã‚‰ä¸Šé™ã‚¯ãƒªãƒƒãƒ—ï¼‰
  return 1 + 2*(s.ng || 0);
}
function weightedSample(items, n, idGetter){
  const pool = items.map(it => ({it, w: Math.max(1, weightById(idGetter(it)))}));
  const picked = [];
  for(let k=0; k<Math.min(n, pool.length); k++){
    const sum = pool.reduce((a,b)=>a+b.w, 0);
    let r = Math.random() * sum;
    let idx = -1;
    for(let i=0;i<pool.length;i++){
      r -= pool[i].w;
      if(r<=0){ idx=i; break; }
    }
    if(idx<0) idx = pool.length-1;
    picked.push(pool[idx].it);
    pool.splice(idx,1);
  }
  return picked;
}
function logAttempt(mode, payload){
  // payload ä¾‹: {label, correctGroup, triedGroup, result:'ok|ng'} or {key, tried, result}
  sessionLog.push({t:Date.now(), mode, ...payload});
  // ç´¯ç©
  const id = payload.label || payload.key;
  if(!id) return;
  const s = statOf(id);
  if(payload.result === 'ok') s.ok++;
  else if(payload.result === 'ng') s.ng++;
  saveStats();
}

/* ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„ ===== */
const summary = document.getElementById('summary');
const sumTitle = document.getElementById('sumTitle');
const sumMeta  = document.getElementById('sumMeta');
const sumBody  = document.getElementById('sumBody');
const btnNext  = document.getElementById('btnNext');
const btnRetry = document.getElementById('btnRetry');
const btnExport = document.getElementById('btnExport');

/* ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–ï¼ˆlocalStorageï¼‰ ===== */
const SESSIONS_KEY = 'wj_sessions_v1';
function loadSessions(){
  try{ return JSON.parse(localStorage.getItem(SESSIONS_KEY) || '[]'); }catch(_){ return []; }
}
function saveSessions(list){ localStorage.setItem(SESSIONS_KEY, JSON.stringify(list)); }
function downloadJSON(name, data){
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

// ===== ã‚µã‚¤ãƒ¬ãƒ³ãƒˆä¿å­˜ãƒ»æ‰‹å‹•è¦ç´„è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ =====
function makeRecordFromSession(mode){
  const total = sessionLog.length;
  const ok = sessionLog.filter(x=>x.result==='ok').length;
  const ng = sessionLog.filter(x=>x.result==='ng').length;
  const rate = total ? Math.round(ok/total*100) : 0;
  const startedAt = sessionLog.length ? new Date(sessionLog[0].t) : new Date();
  const endedAt   = new Date();
  const missMap = {};
  sessionLog.filter(x=>x.result==='ng').forEach(x=>{ const id = x.label || x.key; missMap[id]=(missMap[id]||0)+1; });
  const topMiss = Object.entries(missMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
  return {
    mode,
    startedAt: startedAt.toISOString(),
    endedAt: endedAt.toISOString(),
    ok, ng, total, rate,
    topMiss: topMiss.map(([id,cnt])=>({id,cnt})),
    attempts: [...sessionLog]
  };
}
function saveSessionSilently(mode){
  const record = makeRecordFromSession(mode);
  const sessions = loadSessions();
  sessions.push(record);
  saveSessions(sessions);
  sessionLog = []; // æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰ã«å‘ã‘ã¦ã‚¯ãƒªã‚¢
}
function openLatestSummary(){
  const sessions = loadSessions();
  if(!sessions.length){
    sumTitle.textContent = 'ç›´å‰ã®è¦ç´„';
    sumMeta.textContent = 'ã¾ã ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
    sumBody.innerHTML = '<tr><td colspan="3">ã¾ãšã¯1ãƒ©ã‚¦ãƒ³ãƒ‰éŠã‚“ã§ã¿ã¾ã—ã‚‡ã†ã€‚</td></tr>';
    summary.classList.add('show');
    summary.setAttribute('aria-hidden','false');
    return;
  }
  const record = sessions[sessions.length-1];
  // è¡¨ç¤ºã®ã¿ï¼ˆå†ä¿å­˜ã—ãªã„ï¼‰
  sumTitle.textContent = (record.mode==='group'?'ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘':'ãƒãƒƒãƒãƒ³ã‚°') + 'ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„ï¼ˆç›´å‰ï¼‰';
  sumMeta.textContent = `æ­£è§£ ${record.ok} / è©¦è¡Œ ${record.total}ï¼ˆæ­£ç­”ç‡ ${record.rate}%ï¼‰ | èª¤ç­” ${record.ng}`;
  sumBody.innerHTML = (record.topMiss && record.topMiss.length)
    ? record.topMiss.map(x=>`<tr><td>è‹¦æ‰‹å€™è£œ</td><td>${x.id}</td><td>èª¤ç­” ${x.cnt}</td></tr>`).join('')
    : `<tr><td colspan="3">èª¤ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ˆãã§ãã¾ã—ãŸã€‚</td></tr>`;
  summary.classList.add('show');
  summary.setAttribute('aria-hidden','false');
}

function openSummary(mode){
  // é›†è¨ˆï¼ˆä»Šå›ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
  const total = sessionLog.length;
  const ok = sessionLog.filter(x=>x.result==='ok').length;
  const ng = sessionLog.filter(x=>x.result==='ng').length;
  const rate = total ? Math.round(ok/total*100) : 0;
  const startedAt = sessionLog.length ? new Date(sessionLog[0].t) : new Date();
  const endedAt   = new Date();

  // èª¤ç­”TOP
  const missMap = {};
  sessionLog.filter(x=>x.result==='ng').forEach(x=>{
    const id = x.label || x.key; missMap[id] = (missMap[id]||0)+1;
  });
  const topMiss = Object.entries(missMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

  // è¡¨ç¤º
  sumTitle.textContent = (mode==='group'?'ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘':'ãƒãƒƒãƒãƒ³ã‚°') + 'ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„';
  sumMeta.textContent = `æ­£è§£ ${ok} / è©¦è¡Œ ${total}ï¼ˆæ­£ç­”ç‡ ${rate}%ï¼‰ | èª¤ç­” ${ng}`;
  sumBody.innerHTML = topMiss.length
    ? topMiss.map(([id,cnt])=>`<tr><td>è‹¦æ‰‹å€™è£œ</td><td>${id}</td><td>èª¤ç­” ${cnt}</td></tr>`).join('')
    : `<tr><td colspan="3">èª¤ç­”ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ˆãã§ãã¾ã—ãŸã€‚</td></tr>`;

  // ===== ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ï¼ˆç«¯æœ«å†…ï¼‰ =====
  const sessions = loadSessions();
  const record = {
    mode,
    startedAt: startedAt.toISOString(),
    endedAt: endedAt.toISOString(),
    ok, ng, total, rate,
    topMiss: topMiss.map(([id,cnt])=>({id,cnt})),
    attempts: sessionLog // å¿…è¦ã«å¿œã˜ã¦ä¸¸ã”ã¨ä¿å­˜
  };
  sessions.push(record);
  saveSessions(sessions);

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ï¼ˆã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’JSONã§ä¿å­˜ï¼‰
  if(btnExport){
    btnExport.onclick = ()=>{
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      downloadJSON(`wj-session-${mode}-${stamp}.json`, record);
    };
  }

  summary.classList.add('show');
  summary.setAttribute('aria-hidden','false');
}

function closeSummary(){
  summary.classList.remove('show');
  summary.setAttribute('aria-hidden','true');
  sessionLog = []; // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
}
summary.addEventListener('click', (e)=>{
  if(!e.target.closest('.sheet')) closeSummary();
});

/* ====== ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘å®Ÿè£… ====== */
const bank = document.getElementById('cardBank');
const bankWrap = document.getElementById('bank');
// const bins = [...document.querySelectorAll('.bin')]; // å›ºå®šâ†’å‹•çš„ã«å¤‰æ›´
const groupResult = document.getElementById('groupResult');

// ===== å¯å¤‰ãƒ“ãƒ³æ•°ãƒ»ãƒ†ãƒ¼ãƒå¯¾å¿œ =====
// å¾Œæ–¹äº’æ›ã®æ—¢å®šï¼ˆç¬¬1ã€œç¬¬4é¡ï¼‰ã«åŠ ãˆã€å¯å¤‰ãƒ“ãƒ³å¯¾å¿œã®æ—¢å®šãƒ†ãƒ¼ãƒ
const GROUP_DATASET_FALLBACK = {
  title: 'ç¬¬1ã€œç¬¬4é¡ã®åŸºæœ¬åˆ†é¡',
  bins: [
    { key:'ç¬¬1é¡', title:'ç¬¬1é¡ï¼ˆé…¸åŒ–æ€§å›ºä½“ï¼‰' },
    { key:'ç¬¬2é¡', title:'ç¬¬2é¡ï¼ˆå¯ç‡ƒæ€§å›ºä½“ï¼‰' },
    { key:'ç¬¬3é¡', title:'ç¬¬3é¡ï¼ˆè‡ªç„¶ç™ºç«æ€§/ç¦æ°´æ€§ï¼‰' },
    { key:'ç¬¬4é¡', title:'ç¬¬4é¡ï¼ˆå¼•ç«æ€§æ¶²ä½“ï¼‰' }
  ],
  items: GROUP_DATA.map(x=>({ label:x.label, bin:x.group }))
};

let groupDataset = GROUP_DATASET_FALLBACK; // {title,bins,items}
const binContainer = document.getElementById('binContainer');
const groupTheme = document.getElementById('groupTheme');
const groupThemeSelect = document.getElementById('groupThemeSelect');
let groupCatalog = []; // {id,title,file}

async function loadGroupCatalog(){
  // themes.json ã® group é…åˆ—ã‹ã‚‰å€™è£œã‚’ä½œã‚‹ï¼ˆç„¡ã‘ã‚Œã°é»™ã£ã¦ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  try{
    const res = await fetch('./themes.json', {cache:'no-store'});
    if(!res.ok) throw new Error('themes.json not found');
    const cat = await res.json();
    const arr = (cat && Array.isArray(cat.group)) ? cat.group : [];
    if(arr.length){
      groupCatalog = arr.filter(x=>x && x.file);
      // ã‚»ãƒ¬ã‚¯ãƒˆã¸åæ˜ 
      groupThemeSelect.innerHTML = '';
      groupCatalog.forEach((t, i)=>{
        const opt = document.createElement('option');
        opt.value = t.file;            // ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
        opt.textContent = t.title || t.id || t.file;
        if(i===0) opt.selected = true; // å…ˆé ­ã‚’æ—¢å®š
        groupThemeSelect.appendChild(opt);
      });
      groupThemeSelect.dataset.mode = 'catalog';
    }
  }catch(e){
    // ã‚«ã‚¿ãƒ­ã‚°ãŒç„¡ã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆå¾“æ¥ã® group.json ã‚’ä½¿ã†ï¼‰
    if(groupThemeSelect) groupThemeSelect.dataset.mode = 'single';
  }
}

async function switchGroupThemeByFile(path){
  // æŒ‡å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ dataset ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦æç”»æ›´æ–°
  try{
    const res = await fetch(path, {cache:'no-store'});
    if(!res.ok) throw new Error('theme file not found');
    const obj = await res.json();
    // ---- multi-question file support (random + title display) ----
    groupQFile = path;
    const titleEl = ensureGroupQuestionTitle();
    groupHasMulti = Array.isArray(obj.questions) && obj.questions.length > 0;

    if (groupHasMulti) {
      const idx = Math.floor(Math.random() * obj.questions.length);
      const pick = obj.questions[idx];
      titleEl.textContent = pick.title || `ãŠé¡Œ ${idx + 1}`;
      obj.title = pick.title;
      obj.bins = pick.bins;
      obj.items = pick.items;
    } else {
      titleEl.textContent = obj.title || 'ãŠé¡Œ 1';
    }
    // ---- end of multi-question support ----
    const dataset = loadGroupFromJSON(obj);
    if(!dataset || !dataset.items || !dataset.items.length) throw new Error('invalid theme');
    groupDataset = dataset;
    FULL_GROUP_POOL = [...groupDataset.items];
    if (typeof usedGroup !== 'undefined' && usedGroup && typeof usedGroup.clear === 'function') { usedGroup.clear(); }
  }catch(e){
    console.warn('ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã«å¤±æ•—ï¼š', e.message);
    return;
  }
  // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°ã¨å†æç”»
  if(groupTheme) groupTheme.textContent = (groupDataset.title || 'ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘');
  renderBins();
  bindDnD();
  bank.querySelectorAll('.card').forEach(c => c.remove());
  sampleCurrent();
  renderGroupCards();
  matchedGroupCount = 0;
  groupResult.textContent = 'é€²æ—ï¼š0 / '+groupCards.length;
}

// ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´æ™‚ã®æŒ™å‹•
if(groupThemeSelect){
  groupThemeSelect.addEventListener('change', (e)=>{
    const v = e.target.value;
    if(v && v !== '__auto__'){
      switchGroupThemeByFile(v);
    }
  });
}
function renderBins(){
  binContainer.innerHTML = '';
  groupDataset.bins.forEach(b=>{
    const wrap = document.createElement('div');
    wrap.className = 'bin';
    wrap.dataset.group = b.key;
    wrap.innerHTML = `<div class="bin-title">${b.title || b.key}</div><div class="cards"></div>`;
    binContainer.appendChild(wrap);
  });
}
function allBins(){ return [...binContainer.querySelectorAll('.bin')]; }
// ====== ãƒ¢ãƒã‚¤ãƒ«è£œåŠ©UIå‚ç…§ ======
const assigner = document.getElementById('assigner');
const assignerOpts = document.getElementById('assignerOpts');
const assignerCancel = document.getElementById('assignerCancel');
const assignerTitle = document.getElementById('assignerTitle');
const isSmall = () => window.matchMedia('(max-width:780px)').matches;
let currentCardEl = null;

// ====== å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¼ãƒ«ã¨ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° ======
let FULL_GROUP_POOL = [...GROUP_DATASET_FALLBACK.items];
let usedGroup = new Set(); // ãƒ©ã‚¦ãƒ³ãƒ‰é–“ã®æ—¢å‡ºã‚«ãƒ¼ãƒ‰è¨˜éŒ²ï¼ˆãƒ†ãƒ¼ãƒå†…ï¼‰
const POOL_SIZE = 8;
 let groupCards = [];
 function sampleCurrent(){
   const all = [...FULL_GROUP_POOL];
   // 1) æœªå‡ºã‚’å„ªå…ˆ
   const fresh = all.filter(x => !usedGroup.has(x.label));
   if (fresh.length >= POOL_SIZE) {
     groupCards = weightedSample(fresh, POOL_SIZE, x=>x.label);
   } else {
     // 2) æœªå‡ºãŒä¸è¶³ï¼šä¸€æ—¦ãƒªã‚»ãƒƒãƒˆã—ã¦å…¨ä½“ã‹ã‚‰å†é–‹ï¼ˆé€£ç¶šå­¦ç¿’ã‚’æ­¢ã‚ãªã„ï¼‰
     const remainNeed = POOL_SIZE - fresh.length;
     const pickedFresh = fresh.length ? weightedSample(fresh, fresh.length, x=>x.label) : [];
     // ç›´å‰ãƒ©ã‚¦ãƒ³ãƒ‰ã§ä½¿ã£ãŸã‚‚ã®ã¨åã‚Šã‚’é¿ã‘ã‚‹ãŸã‚ã€ä¸€åº¦ãƒªã‚»ãƒƒãƒˆ
     usedGroup.clear();
     const refillPool = all.filter(x => !pickedFresh.find(p=>p.label===x.label));
     const pickedRefill = weightedSample(refillPool, Math.min(remainNeed, refillPool.length), x=>x.label);
     groupCards = [...pickedFresh, ...pickedRefill];
   }
 }
function updatePoolInfo(){
  const el = document.getElementById('poolInfo');
  if(!el) return;
  const remaining = FULL_GROUP_POOL.filter(x=>!usedGroup.has(x.label)).length;
  const shown = bank.querySelectorAll('.card').length || Math.min(POOL_SIZE, FULL_GROUP_POOL.length);
  el.textContent = `æœªå‡º: ${remaining} / è¡¨ç¤º: ${shown}`;
}


function renderGroupCards(){
  bank.innerHTML = '';
  groupCards.forEach((c,i)=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.draggable = true;
    el.dataset.idx = i;
    el.textContent = normalizeText(c.label);
    el.addEventListener('dragstart', onDragStart);
    el.onclick = null; // å¿µã®ãŸã‚æ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’ã‚¯ãƒªã‚¢
    bank.appendChild(el);
  });
  updatePoolInfo();
}
function onDragStart(e){
  e.dataTransfer.setData('text/plain', e.target.dataset.idx);
}
function allowDrop(e){ e.preventDefault(); }
function applyAssignment(cardEl, binKey){
  const idx = +cardEl.dataset.idx;
  const data = groupCards[idx];
  if(!data) return;
  if(data.bin === binKey){
    cardEl.classList.add('ok','vanish');
    logAttempt('group', { label: data.label, bin: data.bin, tried: binKey, result: 'ok' });
    if(navigator.vibrate) navigator.vibrate([40]);
    setTimeout(()=>{ cardEl.remove(); updateGroupProgress(); }, 220);
  }else{
    cardEl.classList.add('ng');
    logAttempt('group', { label: data.label, bin: data.bin, tried: binKey, result: 'ng' });
    if(navigator.vibrate) navigator.vibrate([20,60,20]);
    setTimeout(()=>{ cardEl.classList.remove('ng'); bank.appendChild(cardEl); }, 280);
  }
}
function onDropBin(e){
  e.preventDefault();
  const idx = e.dataTransfer.getData('text/plain');
  const cardEl = document.querySelector(`.card[data-idx="${idx}"]`);
  const bin = this.dataset.group;
  applyAssignment(cardEl, bin);
}
function onDropBank(e){
  e.preventDefault();
  const idx = e.dataTransfer.getData('text/plain');
  const cardEl = document.querySelector(`.card[data-idx="${idx}"]`);
  bank.appendChild(cardEl);
}
function bindDnD(){
  allBins().forEach(bin=>{
    bin.addEventListener('dragover', allowDrop);
    bin.addEventListener('drop', onDropBin);
    bin.addEventListener('dragenter', ()=>bin.classList.add('hint'));
    bin.addEventListener('dragleave', ()=>bin.classList.remove('hint'));
  });
  bankWrap.addEventListener('dragover', allowDrop);
  bankWrap.addEventListener('drop', onDropBank);
}
// ====== ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆï¼ˆé…å±ï¼‰ ======
function buildAssignerOptions(){
  assignerOpts.innerHTML = '';
  const backBtn = document.createElement('button');
  backBtn.className = 'opt';
  backBtn.textContent = 'â—€ ãƒãƒ³ã‚¯ã«æˆ»ã™';
  backBtn.onclick = () => { if(currentCardEl){ currentCardEl.classList.remove('ok','ng'); bank.appendChild(currentCardEl); closeAssigner(); } };
  assignerOpts.appendChild(backBtn);

  allBins().forEach(bin=>{
    const b = document.createElement('button');
    b.className = 'opt bin';
    const g = bin.dataset.group;
    const title = bin.querySelector('.bin-title')?.textContent || g;
    b.textContent = title;
    b.onclick = () => {
      if(currentCardEl){
    currentCardEl.classList.remove('ok','ng');
    applyAssignment(currentCardEl, g);
    closeAssigner();
  }
    };
    assignerOpts.appendChild(b);
  });
}
function openAssigner(forEl){
  currentCardEl = forEl;
  assignerTitle.textContent = `ã€Œ${forEl.textContent}ã€ã®é…å±å…ˆã‚’é¸æŠ`;
  buildAssignerOptions();
  assigner.classList.add('show');
  assigner.setAttribute('aria-hidden','false');
}
function closeAssigner(){
  assigner.classList.remove('show');
  assigner.setAttribute('aria-hidden','true');
  currentCardEl = null;
}
assignerCancel.addEventListener('click', closeAssigner);
document.addEventListener('click',(e)=>{
  if(!assigner.classList.contains('show')) return;
  if(!e.target.closest('#assigner')) closeAssigner();
}, true);

function handleCardTap(el){
  if(!isSmall()) return; // PCã¯ãƒ‰ãƒ©ãƒƒã‚°å„ªå…ˆ
  openAssigner(el);
}
let matchedGroupCount = 0;
function updateGroupProgress(){
  matchedGroupCount++;
  const total = groupCards.length;
  groupResult.textContent = `é€²æ—ï¼š${matchedGroupCount} / ${total}`;
  if(matchedGroupCount >= total){
    groupResult.innerHTML = `é€²æ—ï¼š${matchedGroupCount} / ${total}ã€€ğŸ‰ ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ æ¬¡ã‚»ãƒƒãƒˆã‚’ç”¨æ„ä¸­â€¦`;
    // ä»Šãƒ©ã‚¦ãƒ³ãƒ‰ã§å‡ºãŸã‚«ãƒ¼ãƒ‰ã‚’æ—¢å‡ºã‚»ãƒƒãƒˆã¸è¿½åŠ 
    groupCards.forEach(c => usedGroup.add(c.label));
    saveSessionSilently('group');
    // å°‘ã—æ¼”å‡ºã—ã¦ã‹ã‚‰è‡ªå‹•ã§æ¬¡ã‚»ãƒƒãƒˆ
    setTimeout(() => {
      if (groupHasMulti && groupQFile) {
        matchedGroupCount = 0;
        switchGroupThemeByFile(groupQFile); // æ¬¡ã®ãŠé¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸
      } else {
        bank.querySelectorAll('.card').forEach(c => c.remove());
        sampleCurrent();
        renderGroupCards();
        matchedGroupCount = 0;
        groupResult.textContent = 'é€²æ—ï¼š0 / ' + groupCards.length;
        updatePoolInfo();
      }
    }, 350);
  }
}
// SPã§ã¯ãƒ“ãƒ³å†…ã‚«ãƒ¼ãƒ‰ã‚‚ã‚¿ãƒƒãƒ—ã§å†é…å±ï¼ˆopenAssigner ã¸ï¼‰
// â€» ã“ã“ã‹ã‚‰ä¸‹ã¯ assigner è¡¨ç¤ºç³»ã®ã¿ã€‚é–‰ã˜å‡¦ç†ã‚„ handleCardTap ã¯ä¸Šå´ã®å®šç¾©ã‚’ä½¿ç”¨
// ====== ã‚¿ãƒƒãƒ—é…å±ç”¨ï¼šã‚·ãƒ¼ãƒˆç”Ÿæˆã¨æ“ä½œ ======
// æ—¢ã«ãƒ“ãƒ³ã«å…¥ã£ãŸã‚«ãƒ¼ãƒ‰ã‚‚ã‚¿ãƒƒãƒ—ã§å†é…å±ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
allBins().forEach(bin=>{
  bin.addEventListener('click', (e)=>{
    const card = e.target.closest('.card');
    if(card && isSmall()){ openAssigner(card); }
  });
});

  function shuffleGroup() {
    // è¤‡æ•°ãŠé¡Œãƒ•ã‚¡ã‚¤ãƒ«ãªã‚‰ã€æ¬¡ãŠé¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ å†é¸æŠ
    if (groupHasMulti && groupQFile) {
      matchedGroupCount = 0;
      switchGroupThemeByFile(groupQFile);
      return;
    }
    // å˜ä¸€ãŠé¡Œï¼šå¾“æ¥ã©ãŠã‚Šã‚«ãƒ¼ãƒ‰ã®ã¿å…¥ã‚Œæ›¿ãˆ
    bank.querySelectorAll('.card').forEach(c => c.remove());
    sampleCurrent();
    renderGroupCards();
    matchedGroupCount = 0;
    groupResult.textContent = 'é€²æ—ï¼š0 / ' + groupCards.length;
  }


// ====== å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ï¼ˆè‡ªå‹•JSONï¼‰ ======
function loadGroupFromJSON(obj){
  // å½¢å¼Aï¼ˆæ–°ï¼‰ï¼š{ title?, bins:[{key,title}], items:[{label,bin,tag?,explain?}] }
  if(obj && Array.isArray(obj.bins) && Array.isArray(obj.items)){
    const title = obj.title || 'ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘';
    return { title, bins: obj.bins, 
    items: obj.items.map(x => ({
        ...x,
        group: x.bin  // â˜…æ­£è§£åˆ¤å®šã§ä½¿ã†ç”¨ã«ã‚³ãƒ”ãƒ¼
      })) };
  }
  // å½¢å¼Bï¼ˆæ—§ï¼‰ï¼š{ group:[{label, group}] } ã¾ãŸã¯é…åˆ—ãã®ã‚‚ã®
  const arr = Array.isArray(obj) ? obj : (obj && Array.isArray(obj.group) ? obj.group : null);
  if(arr){
    return {
      title: GROUP_DATASET_FALLBACK.title,
      bins: GROUP_DATASET_FALLBACK.bins,
      items: arr.map(x=>({ label:x.label, bin:x.group }))
    };
  }
  return null;
}

async function loadDefaultGroup(){
  try{
    const res = await fetch('./group.json', { cache: 'no-store' });
    if(!res.ok) throw new Error('group.json not found');
    const obj = await res.json();
    const dataset = loadGroupFromJSON(obj);
    if(!dataset || !dataset.items || !dataset.items.length) throw new Error('invalid or empty group.json');
    groupDataset = dataset;
    FULL_GROUP_POOL = [...groupDataset.items];
  }catch(e){
    console.warn('å¤–éƒ¨JSONèª­è¾¼ã«å¤±æ•—ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå†…è”µãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ â†’', e.message);
    groupDataset = GROUP_DATASET_FALLBACK;
    FULL_GROUP_POOL = [...groupDataset.items];
  }

  // ãƒ†ãƒ¼ãƒè¡¨ç¤ºã¨ãƒ“ãƒ³ã®å†æç”»
  if (groupTheme) groupTheme.textContent = (groupDataset.title || 'ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘');
  renderBins();
  bindDnD(); // æ–°ã—ã„ãƒ“ãƒ³ã«D&Dã‚’ä»˜ä¸

  // å†ã‚µãƒ³ãƒ—ãƒ«â†’æç”»
  bank.querySelectorAll('.card').forEach(c => c.remove());
  sampleCurrent();
  renderGroupCards();
  matchedGroupCount = 0;
  groupResult.textContent = 'é€²æ—ï¼š0 / '+groupCards.length;
}

renderBins();
bindDnD();
(async ()=>{
  await loadGroupCatalog(); // ã‚ã‚Œã°ã‚»ãƒ¬ã‚¯ãƒˆã«å€™è£œã‚’å…¥ã‚Œã‚‹
  const mode = groupThemeSelect?.dataset?.mode;
  if(mode === 'catalog' && groupThemeSelect.options.length){
    // ã‚«ã‚¿ãƒ­ã‚°ã®å…ˆé ­ãƒ†ãƒ¼ãƒã§é–‹å§‹
    await switchGroupThemeByFile(groupThemeSelect.value);
  }else{
    // å¾“æ¥ã©ãŠã‚Š group.json ã‚’èª­ã‚€
    await loadDefaultGroup();
  }
})();
document.getElementById('shuffleG').onclick = shuffleGroup;
const btnResetG = document.getElementById('resetG');
if(btnResetG) btnResetG.onclick = ()=>{ shuffleGroup(); };
const btnResetM = document.getElementById('resetM');
if(btnResetM) btnResetM.onclick = ()=>{ shuffleMatch(); };
const btnResetMCQ = document.getElementById('resetMCQ');
if(btnResetMCQ) btnResetMCQ.onclick = ()=>{ mcqResetOrder(); mcqRender(); };
const btnShowSummaryG = document.getElementById('showSummaryG');
btnShowSummaryG.onclick = openLatestSummary;

/* ====== ãƒãƒƒãƒãƒ³ã‚°å®Ÿè£…ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒšã‚¢ï¼‰ ====== */
const leftList = document.getElementById('leftList');
const rightList = document.getElementById('rightList');
const pairView = document.getElementById('pairView');
const matchResult = document.getElementById('matchResult');
const matchThemeSelect = document.getElementById('matchThemeSelect');
const matchThemePill   = document.getElementById('matchTheme');
let matchCatalog = []; // {id,title,file}
// --- match multi-question support ---
let matchQFile = null;        // ç¾åœ¨ã®ãƒãƒƒãƒç”¨JSONãƒ‘ã‚¹
let matchHasMulti = false;    // questions[] ãŒã‚ã‚‹ã‹
let matchSwitching = false; // ãƒ†ãƒ¼ãƒåˆ‡æ›¿ä¸­ã‚¬ãƒ¼ãƒ‰ï¼ˆshuffleMatchã¨ã®ç›¸äº’å†å¸°ã‚’é˜²ãï¼‰
function ensureMatchQuestionTitle(){
  const matchLeftHdr = document.getElementById('matchLeftHdr');
  const matchRightHdr = document.getElementById('matchRightHdr');
  let span = document.getElementById('matchQuestionTitle');
  if(!span){
    span = document.createElement('span');
    span.id = 'matchQuestionTitle';
    span.className = 'pill';
    span.style.marginLeft = '8px';
    const themeSel = document.getElementById('matchThemeSelect');
    if(themeSel && themeSel.parentElement){
      themeSel.parentElement.insertBefore(span, themeSel.nextSibling);
    } else {
      const row = document.querySelector('#matchPanel .row');
      row && row.appendChild(span);
    }
  }
  return span;
}


async function loadMatchCatalog(){
  try{
    const res = await fetch('./themes.json', {cache:'no-store'});
    if(!res.ok) throw new Error('themes.json not found');
    const cat = await res.json();
    const arr = (cat && Array.isArray(cat.match)) ? cat.match : [];
    if(arr.length){
      matchCatalog = arr.filter(x=>x && x.file);
      matchThemeSelect.innerHTML = '';
      matchCatalog.forEach((t,i)=>{
        const opt = document.createElement('option');
        opt.value = t.file; opt.textContent = t.title || t.id || t.file;
        if(i===0) opt.selected = true;
        matchThemeSelect.appendChild(opt);
      });
      matchThemeSelect.dataset.mode = 'catalog';
    }
  }catch(e){
    if(matchThemeSelect) matchThemeSelect.dataset.mode = 'single';
  }
}

async function switchMatchThemeByFile(path){
  try {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error('match theme not found');
    const obj = await res.json();
    matchQFile = path;
    const titleEl = ensureMatchQuestionTitle();

    // äº’æ›ï¼šobj.match ç›´ä¸‹/é…ä¸‹ã„ãšã‚Œã‚‚è¨±å®¹ã€‚
    const srcRoot = obj.match || obj;

    // 1) æ–°å½¢å¼ï¼šquestions[] å„ªå…ˆ
    if (Array.isArray(srcRoot.questions) && srcRoot.questions.length) {
      matchHasMulti = true;
      const idx = Math.floor(Math.random() * srcRoot.questions.length);
      const q = srcRoot.questions[idx];
      titleEl.textContent = q.title || `ãŠé¡Œ ${idx + 1}`;
      const leftRaw = q.left || [];
      const rightRaw = q.right || [];
      // è¦‹å‡ºã—ï¼ˆå•é¡Œâ†’ãƒ•ã‚¡ã‚¤ãƒ«â†’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å„ªå…ˆé †ï¼‰
      const lt = q.leftTitle || srcRoot.leftTitle || 'å·¦ï¼šç”¨èª';
      const rt = q.rightTitle || srcRoot.rightTitle || 'å³ï¼šèª¬æ˜';
      if (matchLeftHdr) matchLeftHdr.textContent = lt;
      if (matchRightHdr) matchRightHdr.textContent = rt;
      FULL_MATCH_LEFT = leftRaw.map(x => ({ label: x.label || x.text || x.key, bin: x.bin || x.key || x.bin }));
      FULL_MATCH_RIGHT = rightRaw.map(x => ({ label: x.label || x.text || x.key, bin: x.bin || x.key || x.bin }));
    } else {
      // 2) æ—§å½¢å¼ï¼šå·¦ãƒ»å³ã®é…åˆ—ã®ã¿
      matchHasMulti = false;
      titleEl.textContent = (srcRoot.title || 'ãŠé¡Œ 1');
      const leftRaw = srcRoot.left || [];
      const rightRaw = srcRoot.right || [];
      const lt = srcRoot.leftTitle || 'å·¦ï¼šç”¨èª';
      const rt = srcRoot.rightTitle || 'å³ï¼šèª¬æ˜';
      if (matchLeftHdr) matchLeftHdr.textContent = lt;
      if (matchRightHdr) matchRightHdr.textContent = rt;
      FULL_MATCH_LEFT = leftRaw.map(x => ({ label: x.label || x.text || x.key, bin: x.bin || x.key || x.bin }));
      FULL_MATCH_RIGHT = rightRaw.map(x => ({ label: x.label || x.text || x.key, bin: x.bin || x.key || x.bin }));
    }
  } catch (e) {
    console.warn('ãƒãƒƒãƒãƒ³ã‚°ã®ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã«å¤±æ•—ï¼š', e.message);
    return;
  }
  matchSwitching = true; // â† å†å¸°é˜²æ­¢é–‹å§‹
  if (matchThemePill) {
    const opt = [...matchThemeSelect.options].find(o => o.value === path);
    matchThemePill.textContent = opt ? opt.textContent : matchThemePill.textContent;
  }
  // ç›´æ¥ã‚µãƒ³ãƒ—ãƒ«â†’æç”»ï¼ˆshuffleMatch ã¯å‘¼ã°ãªã„ï¼‰
  pairs.clear(); selL = selR = null; matchedPairs = 0;
  sampleMatch();
  renderMatch();
  updateMatchPoolInfo();
  matchResult.textContent = `é€²æ—ï¼š0 / ${L.length}`;
  matchSwitching = false; // â† å†å¸°é˜²æ­¢çµ‚äº†
}

if(matchThemeSelect){
  matchThemeSelect.addEventListener('change', (e)=>{
    const v = e.target.value; if(v && v !== '__auto__') switchMatchThemeByFile(v);
  });
}
let L = [], R = [], selL = null, selR = null, pairs = new Map();
let totalPairs = 0; // ä»Šè¡¨ç¤ºã—ã¦ã„ã‚‹ç·ãƒšã‚¢æ•°
let matchedPairs = 0; // æ­£ã—ãæ¶ˆãˆãŸæ•°


// ====== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å‚ç…§ ======
const overlayLeft = document.getElementById('overlayLeft');
const overlayRight = document.getElementById('overlayRight');
function setOverlay(target, text){
  // DnDã§ã¯æœªä½¿ç”¨
}
function clearOverlays(){}

// ====== ãƒãƒƒãƒãƒ³ã‚°ç”¨ï¼šå¤–éƒ¨ãƒ—ãƒ¼ãƒ«ã¨4ä»¶ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° ======
const MATCH_POOL_SIZE = 4; // ç”»é¢è¡¨ç¤ºã¯å¸¸ã«4ãƒšã‚¢
let FULL_MATCH_LEFT = [...MATCH_LEFT];
let FULL_MATCH_RIGHT = [...MATCH_RIGHT];

function sampleMatch(){
  const leftBins = new Set(FULL_MATCH_LEFT.map(x=>x.bin));
  const rightBins = new Set(FULL_MATCH_RIGHT.map(x=>x.bin));
  const commonBins = [...leftBins].filter(b => rightBins.has(b));
  const n = Math.min(MATCH_POOL_SIZE, commonBins.length);
  const pickBins = weightedSample(commonBins.map(b=>({b})), n, x=>x.b).map(x=>x.b);
  L = pickBins.map(b => FULL_MATCH_LEFT.find(x=>x.bin===b)).filter(Boolean);
  R = pickBins.map(b => FULL_MATCH_RIGHT.find(x=>x.bin===b)).filter(Boolean);
  R = rand(R);
}
function updateMatchPoolInfo(){
  const el = document.getElementById('matchPoolInfo');
  if(!el) return;
  const leftBins = new Set(FULL_MATCH_LEFT.map(x=>x.bin));
  const rightBins = new Set(FULL_MATCH_RIGHT.map(x=>x.bin));
  const common = [...leftBins].filter(b=> rightBins.has(b)).length;
  el.textContent = `ãƒ—ãƒ¼ãƒ«: ${common} / è¡¨ç¤º: ${L.length || MATCH_POOL_SIZE}`;
}

function renderMatch(){
  leftList.innerHTML = ''; rightList.innerHTML = '';
  matchedPairs = 0; totalPairs = L.length; // 4æƒ³å®š
  // å·¦ï¼šãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½
  // å·¦
  L.forEach(item => {
    const el = document.createElement('div');
    el.className = 'item';
    el.textContent = normalizeText(item.label);
    el.dataset.bin = item.bin;
    el.dataset.side = 'L';
    el.draggable = true;
    el.addEventListener('dragstart', onMatchDragStart);
    el.addEventListener('dragend', onMatchDragEnd);
    leftList.appendChild(el);
  });
  // å³
  R.forEach(item => {
    const el = document.createElement('div');
    el.className = 'item';
    el.textContent = normalizeText(item.label);
    el.dataset.bin = item.bin;
    el.dataset.side = 'R';
    el.addEventListener('dragover', onMatchDragOver);
    el.addEventListener('dragenter', onMatchDragEnter);
    el.addEventListener('dragleave', onMatchDragLeave);
    el.addEventListener('drop', onMatchDrop);
    rightList.appendChild(el);
  });
  // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ç³»UIã¯ä½¿ã‚ãªã„
  pairView.textContent = 'ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦å¯¾å¿œã™ã‚‹å®šç¾©ã«é‡ã­ã‚‹ã§ã”ã–ã‚‹';
  matchResult.textContent = `é€²æ—ï¼š0 / ${totalPairs}`;
  updateMatchPoolInfo();
  clearOverlays();
}
// ==== DnDç”¨ãƒãƒ³ãƒ‰ãƒ© ====
let draggingBin = null, draggingText = '';

function onMatchDragStart(e){
  const el = e.currentTarget;
  draggingBin = el.dataset.bin;
  draggingText = el.textContent;
  e.dataTransfer.setData('text/plain', draggingBin);
  e.dataTransfer.effectAllowed = 'move';
  el.classList.add('dragging');
}
function onMatchDragEnd(e){
  e.currentTarget.classList.remove('dragging');
  draggingBin = null; draggingText = '';
}
function onMatchDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
function onMatchDragEnter(e){ e.currentTarget.classList.add('dropzone'); }
function onMatchDragLeave(e){ e.currentTarget.classList.remove('dropzone'); }
function onMatchDrop(e){
  e.preventDefault();
  const rightEl = e.currentTarget;
  rightEl.classList.remove('dropzone');
  const triedBin = rightEl.dataset.bin;
  const ok = draggingBin && (draggingBin === triedBin);

  const leftEl = [...leftList.querySelectorAll('.item')]
                  .find(x=>x.textContent===draggingText);
  if(!leftEl) return;

  if(ok){
    logAttempt('match', { label: draggingText, bin: draggingBin, tried: triedBin, result:'ok' });
    leftEl.classList.add('ok','vanish');
    rightEl.classList.add('ok','vanish');
    setTimeout(()=>{ leftEl.remove(); rightEl.remove(); }, 220);
    matchedPairs++;
    matchResult.textContent = `é€²æ—ï¼š${matchedPairs} / ${totalPairs}`;
    if (matchedPairs >= totalPairs) {
      matchResult.innerHTML = `é€²æ—ï¼š${matchedPairs} / ${totalPairs}ã€€ğŸ‰ ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ æ¬¡ã‚»ãƒƒãƒˆã‚’ç”¨æ„ä¸­â€¦`;
      saveSessionSilently('match');
      // å°‘ã—é–“ã‚’ç½®ã„ã¦æ¬¡ã‚»ãƒƒãƒˆã¸ã€‚è¤‡æ•°ãŠé¡Œãƒ•ã‚¡ã‚¤ãƒ«ãªã‚‰æ¬¡ãŠé¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸
      setTimeout(() => {
        pairs.clear(); selL = selR = null;
        if (matchHasMulti && matchQFile && !matchSwitching) {
          switchMatchThemeByFile(matchQFile); // å†…éƒ¨ã§ sampleâ†’render æ¸ˆã¿
        } else {
          sampleMatch();
          renderMatch();
          updateMatchPoolInfo();
          matchedPairs = 0;
          matchResult.textContent = `é€²æ—ï¼š0 / ${L.length}`;
        }
      }, 350);
    }
  }else{
    logAttempt('match', { label: draggingText, bin: draggingBin, tried: triedBin, result:'ng' });
    leftEl.classList.add('miss'); rightEl.classList.add('miss');
    setTimeout(()=>{ leftEl.classList.remove('miss'); rightEl.classList.remove('miss'); }, 280);
  }
}
function selectItem(el){ /* ã‚¯ãƒªãƒƒã‚¯ã«ã‚ˆã‚‹ãƒšã‚¢ãƒªãƒ³ã‚°ã¯ãƒ‰ãƒ©ãƒƒã‚°æ–¹å¼ã«å¤‰æ›´ */ }

function shuffleMatch(){
  pairs.clear(); selL = selR = null;
  clearOverlays();
  matchedPairs = 0;
  // è¤‡æ•°ãŠé¡Œãƒ•ã‚¡ã‚¤ãƒ«ï¼šåˆ‡æ›¿ä¸­ã§ãªã‘ã‚Œã°æ¬¡ãŠé¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ å†é¸æŠ
  if (matchHasMulti && matchQFile && !matchSwitching){
    switchMatchThemeByFile(matchQFile);
    return; // å†…éƒ¨ã§ã‚µãƒ³ãƒ—ãƒ«â†’æç”»æ¸ˆã¿
  }
  sampleMatch();
  renderMatch();
  updateMatchPoolInfo();
  matchResult.textContent = `é€²æ—ï¼š0 / ${L.length}`;
}

// åˆæœŸã‚µãƒ³ãƒ—ãƒ«â†’è¡¨ç¤º
(async ()=>{
  await loadMatchCatalog();
  const mode = matchThemeSelect?.dataset?.mode;
  if(mode === 'catalog' && matchThemeSelect.options.length){
    await switchMatchThemeByFile(matchThemeSelect.value);
  }else{
    sampleMatch(); renderMatch(); updateMatchPoolInfo(); // å¾“æ¥ã©ãŠã‚Š
  }
})();
const btnShowSummaryM = document.getElementById('showSummaryM');
btnShowSummaryM.onclick = openLatestSummary;
/* ====== å››æŠå®Ÿè£…ï¼ˆMCQï¼‰ ====== */
// æœ€å°ã‚»ãƒƒãƒˆï¼ˆã®ã¡ã«å¤–éƒ¨JSONã¸å·®ã—æ›¿ãˆå¯ï¼‰
const MCQ = [
  { id:"q-mcq-1", type:"one", question:"ç¬¬4é¡ã®è¡¨ç¤ºã§æ­£ã—ã„ã‚‚ã®ã¯ï¼Ÿ", hint:"å®šç•ªï¼šç«æ°—å³ç¦",
    options:["ç«æ°—æ³¨æ„","ç«æ°—å³ç¦","é«˜æ¸©æ³¨æ„","è¡æ’ƒæ³¨æ„"], bin: "ç«æ°—å³ç¦", answer:"ç«æ°—å³ç¦",
    reason:"ç¬¬4é¡ã¯å¼•ç«æ€§æ¶²ä½“ã®ãŸã‚â€œç«æ°—å³ç¦â€ãŒæ­£ã—ã„ã€‚", source:"ä¹™å›› åŸºæœ¬" },
  { id:"q-mcq-2", type:"one", question:"â€œå¯ç‡ƒæ€§æ¶²ä½“ãŒç€ç«æºã§ç‡ƒãˆç§»ã‚‹æœ€ä½æ¸©åº¦â€ã¯ï¼Ÿ", hint:"èªå½™ï¼šâ—‹â—‹ç‚¹",
    options:["ç‡ƒç„¼ç‚¹","ç™ºç«ç‚¹","å¼•ç«ç‚¹","æ²¸ç‚¹"], bin:"å¼•ç«ç‚¹", answer: "å¼•ç«ç‚¹",
    reason:"ç€ç«æºã‚ã‚Šã§ç‡ƒãˆç§»ã‚‹æœ€ä½æ¸©åº¦ï¼å¼•ç«ç‚¹ã€‚", source:"ä¹™å›› ç”¨èª" }
];

const mcqThemeSelect = document.getElementById('mcqThemeSelect');
const mcqThemePill   = document.getElementById('mcqTheme');
let mcqCatalog = []; // {id,title,file}

async function loadMCQCatalog(){
  try{
    const res = await fetch('./themes.json', {cache:'no-store'});
    if(!res.ok) throw new Error('themes.json not found');
    const cat = await res.json();
    const arr = (cat && Array.isArray(cat.mcq)) ? cat.mcq : [];
    if(arr.length){
      mcqCatalog = arr.filter(x=>x && x.file);
      mcqThemeSelect.innerHTML='';
      mcqCatalog.forEach((t,i)=>{
        const opt = document.createElement('option');
        opt.value = t.file; opt.textContent = t.title || t.id || t.file;
        if(i===0) opt.selected = true;
        mcqThemeSelect.appendChild(opt);
      });
      mcqThemeSelect.dataset.mode = 'catalog';
    }
  }catch(e){
    if(mcqThemeSelect) mcqThemeSelect.dataset.mode = 'single';
  }
}

async function switchMCQThemeByFile(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    if(!res.ok) throw new Error('mcq theme not found');
    const obj = await res.json();
        let quiz = obj.quiz || (Array.isArray(obj) ? obj : []);
    if (!Array.isArray(quiz) || !quiz.length) throw new Error('empty mcq');
    // æ­£è¦åŒ–ï¼šoptions/choices/opts ã®ã„ãšã‚Œã‹ã‚’ options ã«å¯„ã›ã€bin ã¯ answer ã§è£œå®Œ
    quiz = quiz.map(q => {
      // options/choices/opts ã®ã©ã‚Œã‹ã‚’ options ã«æ­£è¦åŒ–
      const options = Array.isArray(q.options) ? q.options.slice()
        : Array.isArray(q.choices) ? q.choices.slice()
          : Array.isArray(q.opts) ? q.opts.slice() : [];
      const rawAns = (q.answer !== undefined) ? q.answer : ((q.bin !== undefined) ? q.bin : null);
      let answers = Array.isArray(rawAns) ? rawAns.slice() : (rawAns != null ? [rawAns] : []);
      // æ•°å­—æŒ‡å®šï¼ˆ1å§‹ã¾ã‚Šï¼‰ãªã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¸å¤‰æ›
      if (answers.length && answers.every(v => /^\d+$/.test(String(v)))) {
        answers = answers.map(i => options[Number(i) - 1]).filter(Boolean);
      }
      const qtype = q.type || (answers.length > 1 ? 'multi' : 'one');
      return { ...q, options, answer: answers, type: qtype };
    });
    MCQ.length = 0; MCQ.push(...quiz);
  }catch(e){
    console.warn('å››æŠã®ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã«å¤±æ•—ï¼š', e.message);
    return;
  }
  if(mcqThemePill){
    const opt = [...mcqThemeSelect.options].find(o=>o.value===path);
    mcqThemePill.textContent = opt ? opt.textContent : mcqThemePill.textContent;
  }
  mcqResetOrder(); mcqRender();
}

if(mcqThemeSelect){
  mcqThemeSelect.addEventListener('change', (e)=>{
    const v = e.target.value; if(v && v !== '__auto__') switchMCQThemeByFile(v);
  });
}

let mcqOrder = []; let mcqIdx = 0; let mcqCorrect = 0; let mcqDone = 0; let mcqLocked = false;
let mcqMultiSel = new Set(); // è¤‡æ•°é¸æŠã®ä¸€æ™‚ã‚»ãƒƒãƒˆ
function mcqShuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function mcqResetOrder(){ mcqOrder = mcqShuffle([...MCQ.keys()].map(i=>i)); mcqIdx=0; mcqCorrect=0; mcqDone=0; }
function mcqRender(){
  const q = MCQ[mcqOrder[mcqIdx]];
  const qEl = document.getElementById('mcqQuestion');
  const hintEl = document.getElementById('mcqHint');
  const optionsDiv = document.getElementById('mcqOptions');
  const ex = document.getElementById('mcqExplain');
  const meter = document.getElementById('mcqMeterPill');
  const bar = document.getElementById('mcqMultiBar');
  const barHint = document.getElementById('mcqMultiHint');

  
  qEl.textContent = normalizeText(q.question || '(ç„¡é¡Œ)');
  hintEl.textContent = q.hint || '';
  optionsDiv.innerHTML = '';
  ex.style.display = 'none';
  mcqLocked = false;
  mcqMultiSel.clear();
  meter.textContent = `é€²è¡Œ ${mcqCorrect}/${MCQ.length}`;

  // é¸æŠè‚¢
  let opts = Array.isArray(q.options) ? [...q.options]
          : Array.isArray(q.choices) ? [...q.choices]
          : Array.isArray(q.opts)    ? [...q.opts] : [];
  if(!opts.length){
    const warn = document.createElement('div');
    warn.className = 'qhint';
    warn.textContent = 'ã“ã®å•é¡Œã®é¸æŠè‚¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆoptions/choices/opts ã®ã„ãšã‚Œã‹ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ï¼‰ã€‚';
    optionsDiv.appendChild(warn);
    return;
  }

  // æ­£è§£ã¯é…åˆ—ã§ä¿æŒï¼ˆå˜ä¸€ã§ã‚‚é…åˆ—åŒ–ï¼‰
  const answers = Array.isArray(q.answer) ? q.answer : (q.answer!=null ? [q.answer] : []);
  const isMulti = (q.type === 'multi') || (answers.length > 1);
  bar.style.display = isMulti ? 'flex' : 'none';
  barHint.textContent = 'è¤‡æ•°é¸æŠï¼š0ä»¶';

  const shuffled = mcqShuffle([...opts]);
  shuffled.forEach(text=>{
    const c = document.createElement('div');
    c.className = 'card';
    c.textContent = text;

    if(isMulti){
      // è¤‡æ•°ï¼šãƒˆã‚°ãƒ«é¸æŠ
      c.onclick = ()=>{
        if(mcqLocked) return;
        const t = c.textContent;
        if(mcqMultiSel.has(t)){ mcqMultiSel.delete(t); c.classList.remove('selected'); }
        else { mcqMultiSel.add(t); c.classList.add('selected'); }
        barHint.textContent = `è¤‡æ•°é¸æŠï¼š${mcqMultiSel.size}ä»¶`;
      };
    }else{
      // å˜ä¸€ï¼šå³åˆ¤å®š
      c.onclick = ()=> mcqCheckSingle(c, text, answers[0], q);
    }

    optionsDiv.appendChild(c);
  });
}
function mcqCheckSingle(card, text, correct, q){
  if(mcqLocked) return; mcqLocked = true;
  const all = [...document.querySelectorAll('#mcqOptions .card')];
  all.forEach(el=>{
    if(el.textContent === correct) el.classList.add('correct');
    else if(el === card) el.classList.add(text===correct ? 'correct' : 'wrong');
    el.style.pointerEvents='none';
  });
  const ok = (text === correct);
  logAttempt('mcq', { label:q.id, bin: [correct], tried: [text], result: ok?'ok':'ng' });
  if (ok) { mcqCorrect++; if(navigator.vibrate) navigator.vibrate([30]); }
  document.getElementById('mcqReason').innerHTML = `<strong>${ok?'æ­£è§£ï¼':'ä¸æ­£è§£â€¦'}</strong>ã€€${q.reason||''}`;
  document.getElementById('mcqSource').textContent = q.source || '';
  document.getElementById('mcqExplain').style.display='block';
  document.getElementById('mcqMeterPill').textContent = `é€²è¡Œ ${mcqCorrect}/${MCQ.length}`;
}
function mcqCheck(card, text, q){
  if(mcqLocked) return; mcqLocked = true;
  const all = [...document.querySelectorAll('#mcqOptions .card')];
  // bin çµ±ä¸€ï¼šæ­£è§£è¡¨ç¤ºã¯ bin ã‚’åŸºæº–ï¼ˆanswer ã¯å¾Œæ–¹äº’æ›ï¼‰
  all.forEach(el=>{
    if(el.textContent === (q.bin || q.answer)) { el.classList.add('correct'); }
    else if(el === card) { el.classList.add('wrong'); }
    el.style.pointerEvents='none';
  });
  const isC = (text === (q.bin || q.answer));
  logAttempt('mcq', { label:q.id, bin:(q.bin||q.answer), tried:text, result:isC?'ok':'ng' });
  if (isC) { mcqCorrect++; }
  document.getElementById('mcqReason').innerHTML = `<strong>${isC?'æ­£è§£ï¼':'ä¸æ­£è§£â€¦'}</strong>ã€€${q.reason||''}`;
  document.getElementById('mcqSource').textContent = q.source || '';
  document.getElementById('mcqExplain').style.display='block';
  document.getElementById('mcqMeterPill').textContent = `é€²è¡Œ ${mcqCorrect}/${MCQ.length}`;
}
function mcqNext(){
  mcqLocked = false;
  if(mcqIdx < mcqOrder.length-1){ mcqIdx++; mcqRender(); }
  else{
    saveSessionSilently('mcq'); // é™ã‹ã«ä¿å­˜
    // çµ‚äº†è¡¨ç¤º
    document.getElementById('mcqQuestion').textContent = `ãŠç–²ã‚Œã•ã¾ï¼ æ­£ç­” ${mcqCorrect} / ${MCQ.length}`;
    document.getElementById('mcqHint').textContent = 'ã‚‚ã†ä¸€åº¦ã‚„ã‚‹ã¨ãã¯ã€Œæ¬¡ã®å•é¡Œã¸ã€ã‚’æŠ¼ã—ã¦ä¸¦ã³æ›¿ãˆã‚‹ã§ã”ã–ã‚‹ã€‚';
    document.getElementById('mcqOptions').innerHTML = '';
    document.getElementById('mcqExplain').style.display = 'none';
  }
}
function mcqRetry(){ mcqLocked = false; mcqRender(); }

const mcqCommitBtn = document.getElementById('mcqCommit');
if (mcqCommitBtn){
  mcqCommitBtn.onclick = ()=>{
    const q = MCQ[mcqOrder[mcqIdx]];
    if(mcqLocked) return;
    const correctArr = Array.isArray(q.answer) ? q.answer : (q.answer!=null ? [q.answer] : []);
    const selArr = Array.from(mcqMultiSel);

    const eq = (a,b)=> a.length===b.length && a.every(x=> b.includes(x));
    const ok = eq(selArr, correctArr);

    mcqLocked = true;
    const all = [...document.querySelectorAll('#mcqOptions .card')];
    all.forEach(el=>{
      const t = el.textContent;
      if (correctArr.includes(t)) el.classList.add('correct');
      if (mcqMultiSel.has(t) && !correctArr.includes(t)) el.classList.add('wrong');
      el.style.pointerEvents='none';
    });

    logAttempt('mcq', { label:q.id, bin: correctArr, tried: selArr, result: ok?'ok':'ng' });
    if (ok) { mcqCorrect++; if(navigator.vibrate) navigator.vibrate([40]); }
    document.getElementById('mcqReason').innerHTML = `<strong>${ok?'æ­£è§£ï¼':'ä¸æ­£è§£â€¦'}</strong>ã€€${q.reason||''}`;
    document.getElementById('mcqSource').textContent = q.source || '';
    document.getElementById('mcqExplain').style.display='block';
    document.getElementById('mcqMeterPill').textContent = `é€²è¡Œ ${mcqCorrect}/${MCQ.length}`;
  };
}

document.getElementById('mcqNextBtn').addEventListener('click', mcqNext);
document.getElementById('mcqRetryBtn').addEventListener('click', mcqRetry);
mcqResetOrder(); mcqRender();
const btnShowSummaryMCQ = document.getElementById('showSummaryMCQ');
btnShowSummaryMCQ.onclick = openLatestSummary;
/* ====== ã‚¿ãƒ–åˆ‡æ›¿ ====== */
const tabG = document.getElementById('tabGroup');
const tabM = document.getElementById('tabMatch');
const tabC = document.getElementById('tabMCQ');
const pG = document.getElementById('groupPanel');
const pM = document.getElementById('matchPanel');
const pC = document.getElementById('mcqPanel');
function activate(tab){
  [tabG,tabM,tabC].forEach(t=>t.classList.remove('active'));
  [pG,pM,pC].forEach(p=>p.style.display='none');
  if(tab==='G'){ tabG.classList.add('active'); pG.style.display='block'; }
  if(tab==='M'){ tabM.classList.add('active'); pM.style.display='block'; }
  if(tab==='C'){ tabC.classList.add('active'); pC.style.display='block'; }
}
// ã‚¯ãƒªãƒƒã‚¯
tabG.onclick = ()=>activate('G');
tabM.onclick = ()=>activate('M');
tabC.onclick = ()=>activate('C');

// ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„ã®ãƒœã‚¿ãƒ³å‹•ä½œï¼ˆ3ãƒ‘ãƒãƒ«å…±é€šï¼‰
btnNext.addEventListener('click', ()=>{
  closeSummary();
  if (pM.style.display !== 'none') {      // ãƒãƒƒãƒãƒ³ã‚°
    shuffleMatch();
  } else if (pC.style.display !== 'none') { // å››æŠ
    mcqResetOrder(); mcqRender();
  } else {                                 // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
    shuffleGroup();
  }
});
btnRetry.addEventListener('click', ()=>{
  closeSummary();
  if (pM.style.display !== 'none') {      // ãƒãƒƒãƒãƒ³ã‚°
    renderMatch();
    matchedPairs = 0;
    matchResult.textContent = `é€²æ—ï¼š0 / ${totalPairs}`;
  } else if (pC.style.display !== 'none') { // å››æŠ
    mcqRender();
  } else {                                 // ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘
    bank.querySelectorAll('.card').forEach(c => c.remove());
    renderGroupCards();
    matchedGroupCount = 0;
    groupResult.textContent = 'é€²æ—ï¼š0 / '+groupCards.length;
  }
});
  // ===== ãƒãƒƒãƒãƒ³ã‚°å¤–éƒ¨èª­è¾¼ =====
async function loadDefaultMatch(){
  try{
    const res = await fetch('./match.json', { cache: 'no-store' });
    if(!res.ok) throw new Error('match.json not found');
    const obj = await res.json();
    const src = obj.match || obj; // {left,right} ãŒ match é…ä¸‹ã§ã‚‚ç›´ä¸‹ã§ã‚‚OK
    const leftRaw  = src.left  || [];
    const rightRaw = src.right || [];
    // æ—§ {key,text} â†’ æ–° {label,bin} ã«å¯„ã›ã‚‹
    FULL_MATCH_LEFT  = leftRaw .map(x=>({ label: x.label||x.text||x.key, bin: x.bin||x.key||x.bin }));
    FULL_MATCH_RIGHT = rightRaw.map(x=>({ label: x.label||x.text||x.key, bin: x.bin||x.key||x.bin }));
  }catch(e){
    console.warn('å¤–éƒ¨matchèª­è¾¼å¤±æ•—ã€‚å†…è”µãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ â†’', e.message);
  }
  shuffleMatch();
}

  // ===== å››æŠå¤–éƒ¨èª­è¾¼ =====
  async function loadDefaultMCQ() {
    try {
      const res = await fetch('./mcq.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('mcq.json not found');
      const obj = await res.json();
      if (obj.quiz && Array.isArray(obj.quiz) && obj.quiz.length) {
             let quiz = obj.quiz;
        quiz = quiz.map(q => {
          // options/choices/opts ã®ã©ã‚Œã‹ã‚’ options ã«æ­£è¦åŒ–
          const options = Array.isArray(q.options) ? q.options.slice()
            : Array.isArray(q.choices) ? q.choices.slice()
              : Array.isArray(q.opts) ? q.opts.slice() : [];
          const rawAns = (q.answer !== undefined) ? q.answer : ((q.bin !== undefined) ? q.bin : null);
          let answers = Array.isArray(rawAns) ? rawAns.slice() : (rawAns != null ? [rawAns] : []);
          // æ•°å­—æŒ‡å®šï¼ˆ1å§‹ã¾ã‚Šï¼‰ãªã‚‰ãƒ†ã‚­ã‚¹ãƒˆã¸å¤‰æ›
          if (answers.length && answers.every(v => /^\d+$/.test(String(v)))) {
            answers = answers.map(i => options[Number(i) - 1]).filter(Boolean);
          }
          const qtype = q.type || (answers.length > 1 ? 'multi' : 'one');
          return { ...q, options, answer: answers, type: qtype };
        });
        MCQ.length = 0;
        MCQ.push(...quiz);
      }
    } catch (e) {
      console.warn('å¤–éƒ¨mcqèª­è¾¼å¤±æ•—ã€‚å†…è”µãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ â†’', e.message);
    }
    mcqResetOrder(); mcqRender();
  }

  // èµ·å‹•æ™‚ã«3ç¨®é¡èª­ã¿è¾¼ã‚€
  loadDefaultMatch();
  loadDefaultMCQ();

// MCQ ã‚«ã‚¿ãƒ­ã‚°å„ªå…ˆã®èµ·å‹•ï¼ˆå¾Œæ–¹äº’æ›ã‚ã‚Šï¼‰
(async ()=>{
  await loadMCQCatalog();
  const mode = mcqThemeSelect?.dataset?.mode;
  if(mode === 'catalog' && mcqThemeSelect.options.length){
    await switchMCQThemeByFile(mcqThemeSelect.value);
  }
})();
</script>
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(console.error);
  });
}
</script>
</body>
</html>